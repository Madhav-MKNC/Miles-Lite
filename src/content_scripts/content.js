async function reportIssue(e,t){const r={timestamp:Date(),user_name:await storageUtils.getData("user_name"),user_wa_id:await storageUtils.getData("user_wa_id"),info:e,other_info:t};return new Promise(((e,t)=>{const a=setTimeout((()=>{console.log("Timeout: Issue reporting took too long."),t(new Error("Timeout: Issue reporting took too long."))}),5e3);chrome.runtime.sendMessage({type:"report_issue",data:r},(r=>{clearTimeout(a),r&&r.success?e(r.response):t(r.error||new Error("Unknown error occurred during issue reporting."))}))}))}async function report_error(...e){const t=e.join(" ");console.log("[MILES ERROR]",t),await reportIssue("[frontend] low level error",t)}const STORAGE_KEY="miles2",localStorageUtils={storageKey:"miles2miles2",updateToggleState:function(e){try{const t=localStorage.getItem(this.storageKey),r=t?JSON.parse(t):{};r.toggleState=e,localStorage.setItem(this.storageKey,JSON.stringify(r))}catch(e){console.log("Error updating toggle state:",e)}},getToggleState:function(){try{const e=localStorage.getItem(this.storageKey);return!!e&&JSON.parse(e).toggleState}catch(e){return console.log("Error getting toggle state:",e),!1}}},storageUtils={storageKey:"miles2",defaultConversationData:{goal:"",preamble:"",impression:"",latest_chat:{},prev_replies:[]},defaultData:{conversation_data:{test_chatname:{goal:"",preamble:"",impression:"",latest_chat:{},prev_replies:[]}},user_name:"",user_wa_id:"",user_persona:"The person is a direct and adaptable communicator, switching between formal and informal tones as needed. They use slang occasionally, engage in playful mockery, and respect some but not all. They dislike repetitive conversations and adjust their style based on the situation. Busy with their own life, they keep things straight to the point."},readData:async function(){return new Promise(((e,t)=>{try{chrome.storage.local.get(this.storageKey,(r=>{if(chrome.runtime.lastError)t(new Error(chrome.runtime.lastError));else{const t=r[this.storageKey]?JSON.parse(r[this.storageKey]):this.defaultData;e(t)}}))}catch(e){t(new Error("Error reading data from storage"))}}))},writeData:async function(e){return new Promise(((t,r)=>{try{const a={};a[this.storageKey]=JSON.stringify(e),chrome.storage.local.set(a,(()=>{chrome.runtime.lastError?r(new Error(chrome.runtime.lastError)):t()}))}catch(e){r(new Error("Error writing data to storage"))}}))},updateData:async function(e,t){try{const r=await this.readData();r[e]=t,await this.writeData(r)}catch(e){report_error("Error updating data:",e.message)}},getData:async function(e){try{return(await this.readData())[e]}catch(e){report_error("Error getting data:",e.message)}},getConversationData:async function(e,t){try{const r=await this.getData("conversation_data");return r[e]&&r[e][t]?r[e][t]:this.defaultConversationData[t]}catch(e){report_error("Error getting conversation data:",e.message)}},updateConversationData:async function(e,t,r){try{const a=await this.getData("conversation_data");a[e]||(a[e]={...this.defaultConversationData}),a[e][t]=r,await this.updateData("conversation_data",a)}catch(e){report_error("Error updating conversation data:",e.message)}},updateReplyState:async function(e,t,r){try{const a=await this.getData("conversation_data");a[e]||(a[e]={...this.defaultConversationData}),a[e].prev_replies||(a[e].prev_replies=this.defaultConversationData.prev_replies),a[e].latest_chat||(a[e].latest_chat=this.defaultConversationData.latest_chat),JSON.stringify(t)!==JSON.stringify(a[e].latest_chat)&&(a[e].latest_chat=t,a[e].prev_replies=[]),a[e].prev_replies.push(r),await this.updateData("conversation_data",a)}catch(e){report_error("Error appending new reply in prev_replies:",e.message)}}},CHATNAME_SELECTOR=".xggjnk3",DEFAULT_SENDER="Unknown Sender";function sleep(e){return new Promise((t=>setTimeout(t,e)))}async function getThisUserId(){try{const e=localStorage.getItem("last-wid-md"),t=e?e.match(/"(\d+):/)[1]:"";if(!t){const e="content_script.js failed to fetch thisUserID (user's WA number/ID) from localStorage of WA web, might need to update the 'last-wid-md' item key";throw await reportIssue(e,"LocalStorage item missing or key changed."),new Error(e)}return await storageUtils.updateData("user_wa_id",t),t}catch(e){throw console.log("Failed to get user ID:",e.message),e}}async function getOtherUserId(){try{const e=document.querySelector("[data-id]");if(!e)throw new Error("Element with 'data-id' not found.");return e.getAttribute("data-id").match(/_(.*?)@/)[1]}catch(e){return console.log("An error occurred:",e.message),await reportIssue("content_script.js failed to fetch otherUserID (chat's WA number/ID)",e),""}}async function getOtherUser(){try{const e=document.querySelector("#main header"),t=e?.querySelector('span[dir="auto"]'),r=t?.innerText.trim();if(!r){const e="content_script.js failed to fetch otherUser (chatname), selector may need an update.";throw await reportIssue(e,""),new Error(e)}return r}catch(e){return console.log("Failed to get other user:",e.message),""}}async function fetchWhatsAppMessages(){try{const e=document.querySelectorAll("div.copyable-text"),t=[];if(!e.length)return console.log("No message elements found in the DOM, possibly a new chat without messages."),t;for(const r of e)try{const e=r.querySelector("span.selectable-text");if(!e)continue;const a=e.innerText,o=r.getAttribute("data-pre-plain-text");if(!o){await reportIssue("PreText attribute not found in message elements","Error in fetchWhatsAppMessages()");continue}const n=o.indexOf("]")+2,s=o.lastIndexOf(":"),i=-1!==n&&-1!==s?o.substring(n,s).trim():DEFAULT_SENDER;i===DEFAULT_SENDER&&await reportIssue("Failed to extract sender. Will use DEFAULT_SENDER.",`PreText: ${o}`),r.closest(".message-out")&&await storageUtils.updateData("user_name",i),t.push({sender:i,message:a})}catch(e){await reportIssue("Error processing a message element.",`${e.message}, Element: ${r.outerHTML}`)}return t}catch(e){return console.log("Failed to fetch WhatsApp messages:",e.message),[]}}async function insertReply(e){try{let t=document.querySelector("footer").querySelector('div[contenteditable="true"]');if(t){t.focus(),await sleep(10);const r=window.getSelection(),a=document.createRange();a.selectNodeContents(t),r.removeAllRanges(),r.addRange(a),await sleep(10);const o=new InputEvent("input",{inputType:"insertText",data:e,dataTransfer:null,isComposing:!1,bubbles:!0,cancelable:!0,composed:!0,target:t});t.dispatchEvent(o)}else console.log("Reply box not found")}catch(e){console.log("Error inserting reply:",e)}}const replyElements=[];async function generate_and_insert_reply(e,t){try{const r=document.querySelector("footer");if(!r)throw new Error("Input bar not found");const a=document.createElement("div");a.className="reply-loading";const o=document.createElement("div");o.className="spinner";const n=document.createElement("span");n.innerText="Generating reply...",a.appendChild(o),a.appendChild(n);let s=70;replyElements.forEach((e=>{e.style.bottom=`${s}px`,s+=e.offsetHeight+5})),r.insertBefore(a,r.firstChild),a.style.bottom=`${s}px`,replyElements.unshift(a);const i=await new Promise(((t,r)=>{chrome.runtime.sendMessage({type:"get_reply",data:e},(e=>{e.error?r(new Error(e.error)):t(e.reply_response)}))})),l=i.reply||"*[no reply]*",c=i.preamble||await storageUtils.getConversationData(t,"preamble"),u=i.impression||await storageUtils.getConversationData(t,"impression"),d=i.goal||await storageUtils.getConversationData(t,"goal"),p=e.chats[e.chats.length-1];await storageUtils.updateReplyState(t,p,l),await storageUtils.updateConversationData(t,"preamble",c),await storageUtils.updateConversationData(t,"impression",u),await storageUtils.updateConversationData(t,"goal",d),a.className="reply-element",a.innerText=l,s=70,replyElements.forEach((e=>{e.style.bottom=`${s}px`,s+=e.offsetHeight+5})),a.addEventListener("click",(async()=>{try{await navigator.clipboard.writeText(l),console.log("Copied to clipboard successfully!"),a.remove();const e=replyElements.indexOf(a);e>-1&&replyElements.splice(e,1),s=70,replyElements.forEach((e=>{e.style.bottom=`${s}px`,s+=e.offsetHeight+5})),insertReply(l)}catch(e){console.log("Error copying to clipboard:",e)}}))}catch(e){console.log("Error generating and inserting reply:",e)}}async function fetch_raw_reply_input(){try{const e=document.querySelector("footer"),t=e?.querySelector('div[contenteditable="true"]'),r=t?.innerText.trim()||"";return console.log("Raw reply input:",r),r}catch(e){return console.log("Error fetching raw reply input:",e),""}}async function milesGenerate(e,t,r,a){try{console.log("Generating reply...");const o=await getOtherUser(),n={thisUser:await storageUtils.getData("user_name"),thisUserID:await getThisUserId(),otherUser:o,otherUserID:await getOtherUserId(),persona:await storageUtils.getData("user_persona"),chats:await fetchWhatsAppMessages(),preamble:await storageUtils.getConversationData(o,"preamble"),impression:await storageUtils.getConversationData(o,"impression"),keywords:e,tone:t,goal:await storageUtils.getConversationData(o,"goal"),refine:r,raw_reply:a,prev_replies:await storageUtils.getConversationData(o,"prev_replies")};await generate_and_insert_reply(n,o),console.log("Reply generated successfully")}catch(e){console.log("Error generating reply:",e)}}function overridePlaceholderText(e){const t=()=>{const t=e.querySelector('div[aria-hidden="true"]');if(!t)return;const r=e=>{for(let t of e.childNodes)if(t.nodeType===Node.TEXT_NODE){if("type a message"===t.textContent.trim().toLowerCase())return t.textContent="Write anything and MILES will refine it!",!0}else if(r(t))return!0;return!1};r(t)};t();new MutationObserver(t).observe(e,{childList:!0,subtree:!0,characterData:!0})}function insertMilesInlineUI(){const e=document.querySelector("footer");if(!e||document.getElementById("miles-inline-container"))return;overridePlaceholderText(e);const t=document.createElement("div");t.id="miles-inline-container";const r=document.createElement("button");r.id="miles-refine-btn",r.textContent="Refine Your Reply",r.onclick=async()=>{const e=await fetch_raw_reply_input(),t=l.value,r=c.value;await milesGenerate(r,t,!0,e)};const a=document.createElement("button");a.id="miles-generate-btn",a.textContent="MILES Reply",a.onclick=async()=>{const e=l.value,t=c.value;await milesGenerate(t,e,!1,"")};const o=document.createElement("button");o.id="miles-float-btn",o.textContent="⚙️",o.innerHTML=`<img src="${chrome.runtime.getURL("icon.png")}" alt="⚙️">`;const n=document.createElement("div");n.id="miles-float-window";const s=document.createElement("div");s.id="miles-float-tone-container";const i=document.createElement("label");i.id="miles-float-tone-label",i.textContent="Select tone for reply:";const l=document.createElement("select");l.id="miles-tone-select";[{value:"normal",text:"Normal"},{value:"formal",text:"Formal"},{value:"positive",text:"Positive"},{value:"negative",text:"Negative"},{value:"random",text:"Random"},{value:"angry",text:"Angry"},{value:"haha",text:"Haha"},{value:"superior",text:"Superior"},{value:"seductive",text:"Seductive"},{value:"serious",text:"Serious"},{value:"roast",text:"Roast"}].forEach((e=>{const t=document.createElement("option");t.value=e.value,t.textContent=e.text,l.appendChild(t)})),s.appendChild(i),s.appendChild(l);const c=document.createElement("input");c.id="keywordInput",c.placeholder="Keywords (optional)",c.maxLength="250",n.appendChild(s),n.appendChild(c);let u=!1;o.onclick=()=>{u=!u,n.style.display=u?"block":"none"};let d=null;o.addEventListener("mouseenter",(()=>{u||(d=setTimeout((()=>{n.style.display="block"}),300))})),n.addEventListener("mouseenter",(()=>{u||(clearTimeout(d),n.style.display="block")})),o.addEventListener("mouseleave",(()=>{u||(clearTimeout(d),setTimeout((()=>{n.matches(":hover")||o.matches(":hover")||(n.style.display="none")}),200))})),n.addEventListener("mouseleave",(()=>{u||setTimeout((()=>{n.matches(":hover")||o.matches(":hover")||(n.style.display="none")}),200)})),t.appendChild(r),t.appendChild(a),t.appendChild(o),t.appendChild(n),document.addEventListener("click",(e=>{n.contains(e.target)||o.contains(e.target)||(n.style.display="none",u=!1)}));const p=e.querySelector('div[aria-hidden="true"]');if(p&&p.parentNode){const e=p.parentNode;e.parentNode.insertBefore(t,e.nextSibling)}observeInputForRefineButton(r)}function observeInputForRefineButton(e){const t=document.querySelector('footer div[contenteditable="true"]');if(!t)return;const r=()=>{const r=t.innerText.trim();e.style.display=r.length>0?"inline-block":"none"};t.addEventListener("input",r);new MutationObserver(r).observe(t,{childList:!0,characterData:!0,subtree:!0}),r()}function observeFooterAndInjectUI(){new MutationObserver((()=>{try{document.querySelector("footer")&&!document.getElementById("miles-inline-container")&&insertMilesInlineUI()}catch(e){console.log("Observer failed after context reload:",e)}})).observe(document.body,{childList:!0,subtree:!0})}let lastUrl=location.href;new MutationObserver((()=>{const e=location.href;e!==lastUrl&&(lastUrl=e,setTimeout((()=>{observeFooterAndInjectUI()}),1e3))})).observe(document,{subtree:!0,childList:!0}),observeFooterAndInjectUI();